// Basketball Shooting Analysis System - New Schema
// Database: PostgreSQL (compatible with Abacus AI)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER PROFILE (App users who want analysis)
// ============================================
model UserProfile {
  id                    String    @id @default(cuid())
  
  // Physical Measurements
  heightInches          Int?      @map("height_inches")
  weightLbs             Int?      @map("weight_lbs")
  wingspanInches        Int?      @map("wingspan_inches")
  
  // Demographics
  age                   Int?
  
  // Experience & Body Type
  experienceLevel       String?   @map("experience_level") @db.VarChar(50) // beginner/intermediate/advanced/professional
  bodyType              String?   @map("body_type") @db.VarChar(50)        // ectomorph/mesomorph/endomorph
  
  // Derived Values
  coachingTier          String?   @map("coaching_tier") @db.VarChar(50)    // elementary/middle_school/high_school/college/professional
  wingspanToHeightRatio Decimal?  @map("wingspan_to_height_ratio") @db.Decimal(5, 2)
  bmi                   Decimal?  @db.Decimal(5, 2)
  
  // Metadata
  profileComplete       Boolean   @default(false) @map("profile_complete")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  
  // Relations
  analyses              UserAnalysis[]
  
  // Indexes
  @@index([experienceLevel], name: "idx_user_experience")
  @@index([bodyType], name: "idx_user_body_type")
  @@index([coachingTier], name: "idx_user_coaching_tier")
  @@index([heightInches], name: "idx_user_height")
  
  @@map("user_profiles")
}

// ============================================
// USER ANALYSIS (Analysis sessions for app users)
// ============================================
model UserAnalysis {
  id                    String    @id @default(cuid())
  userProfileId         String    @map("user_profile_id")
  
  // Image Data
  imageUrl              String?   @map("image_url") @db.VarChar(500)
  s3Path                String?   @map("s3_path") @db.VarChar(500)
  
  // Phase 4: RoboFlow Pose Detection Data
  roboflowPoseData      Json?     @map("roboflow_pose_data")    // 10 body points from pose estimation
  roboflowDetection     Json?     @map("roboflow_detection")    // Basketball detection
  shootingPhase         String?   @map("shooting_phase") @db.VarChar(50) // stance/dip/rise/release/follow_through
  
  // Phase 4: Calculated Angles
  elbowAngle            Decimal?  @map("elbow_angle") @db.Decimal(5, 2)
  kneeAngle             Decimal?  @map("knee_angle") @db.Decimal(5, 2)
  wristAngle            Decimal?  @map("wrist_angle") @db.Decimal(5, 2)
  shoulderAngle         Decimal?  @map("shoulder_angle") @db.Decimal(5, 2)
  hipAngle              Decimal?  @map("hip_angle") @db.Decimal(5, 2)
  releaseAngle          Decimal?  @map("release_angle") @db.Decimal(5, 2)
  
  // Analysis Results (JSON)
  visionAnalysis        Json?     @map("vision_analysis")       // GPT-4 Vision response
  bodyPositions         Json?     @map("body_positions")        // Detected body part positions
  
  // Phase 4: Visual Enhancements
  annotatedImageUrl     String?   @map("annotated_image_url") @db.VarChar(500) // ShotStack/Custom annotated image
  annotatedS3Path       String?   @map("annotated_s3_path") @db.VarChar(500)
  visualOverlays        Json?     @map("visual_overlays")       // Overlay configuration data
  
  // Scores
  overallScore          Decimal?  @map("overall_score") @db.Decimal(5, 2)
  formScore             Decimal?  @map("form_score") @db.Decimal(5, 2)
  balanceScore          Decimal?  @map("balance_score") @db.Decimal(5, 2)
  releaseScore          Decimal?  @map("release_score") @db.Decimal(5, 2)
  consistencyScore      Decimal?  @map("consistency_score") @db.Decimal(5, 2)
  
  // Feedback
  strengths             Json?                                   // Array of strength objects
  improvements          Json?                                   // Array of improvement objects
  drills                Json?                                   // Array of recommended drills
  coachingNotes         String?   @map("coaching_notes") @db.Text
  
  // Matched Shooter (who they're most similar to)
  matchedShooterId      Int?      @map("matched_shooter_id")
  matchConfidence       Decimal?  @map("match_confidence") @db.Decimal(3, 2)
  similarShooters       Json?     @map("similar_shooters")      // Top 3-5 similar shooters
  
  // Processing Status
  processingStatus      String?   @map("processing_status") @db.VarChar(50) @default("pending") // pending/processing/completed/failed
  processingError       String?   @map("processing_error") @db.Text
  
  // Metadata
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  
  // Relations
  userProfile           UserProfile @relation(fields: [userProfileId], references: [id], onDelete: Cascade)
  historyEntries        AnalysisHistory[]
  
  // Indexes
  @@index([userProfileId], name: "idx_analysis_user")
  @@index([createdAt], name: "idx_analysis_date")
  @@index([matchedShooterId], name: "idx_analysis_matched")
  @@index([shootingPhase], name: "idx_shooting_phase")
  @@index([processingStatus], name: "idx_processing_status")
  
  @@map("user_analyses")
}

// ============================================
// ANALYSIS HISTORY (Track progress over time)
// ============================================
model AnalysisHistory {
  id                    String    @id @default(cuid())
  userProfileId         String    @map("user_profile_id")
  analysisId            String    @map("analysis_id")
  
  // Snapshot of key metrics at time of analysis
  overallScore          Decimal   @map("overall_score") @db.Decimal(5, 2)
  formScore             Decimal?  @map("form_score") @db.Decimal(5, 2)
  balanceScore          Decimal?  @map("balance_score") @db.Decimal(5, 2)
  releaseScore          Decimal?  @map("release_score") @db.Decimal(5, 2)
  consistencyScore      Decimal?  @map("consistency_score") @db.Decimal(5, 2)
  
  // Improvement tracking
  scoreChange           Decimal?  @map("score_change") @db.Decimal(5, 2) // Change from previous analysis
  improvementAreas      Json?     @map("improvement_areas")              // What improved
  regressionAreas       Json?     @map("regression_areas")               // What got worse
  
  // Key angles snapshot
  elbowAngle            Decimal?  @map("elbow_angle") @db.Decimal(5, 2)
  kneeAngle             Decimal?  @map("knee_angle") @db.Decimal(5, 2)
  releaseAngle          Decimal?  @map("release_angle") @db.Decimal(5, 2)
  
  // Progress notes
  progressNotes         String?   @map("progress_notes") @db.Text
  milestonesAchieved    Json?     @map("milestones_achieved")           // Array of milestone objects
  
  // Metadata
  analysisDate          DateTime  @map("analysis_date") @default(now())
  createdAt             DateTime  @default(now()) @map("created_at")
  
  // Relations
  analysis              UserAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  
  // Indexes
  @@index([userProfileId], name: "idx_history_user")
  @@index([analysisDate], name: "idx_history_date")
  @@index([analysisId], name: "idx_history_analysis")
  @@index([userProfileId, analysisDate], name: "idx_history_user_date")
  
  @@map("analysis_history")
}

// ============================================
// TABLE 1: shooters (Professional shooter database)
// ============================================
model Shooter {
  id                    Int       @id @default(autoincrement()) @map("shooter_id")
  name                  String    @db.VarChar(255)
  position              String?   @db.VarChar(50)       // Guard/Forward/Center
  heightInches          Int?      @map("height_inches")
  weightLbs             Int?      @map("weight_lbs")
  wingspanInches        Int?      @map("wingspan_inches")
  armLengthInches       Int?      @map("arm_length_inches")
  bodyType              String?   @map("body_type") @db.VarChar(100)
  dominantHand          String?   @map("dominant_hand") @db.VarChar(20) // Left/Right/Ambidextrous
  careerFgPercentage    Decimal?  @map("career_fg_percentage") @db.Decimal(5, 2)
  career3ptPercentage   Decimal?  @map("career_3pt_percentage") @db.Decimal(5, 2)
  careerFtPercentage    Decimal?  @map("career_ft_percentage") @db.Decimal(5, 2)
  shootingStyle         String?   @map("shooting_style") @db.VarChar(100) // One-motion/Two-motion/Set shot
  era                   String?   @db.VarChar(50)       // Modern/Classic/Historical
  skillLevel            String?   @map("skill_level") @db.VarChar(50) // Professional/College/High School/Amateur
  profileImageUrl       String?   @map("profile_image_url") @db.VarChar(500)
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @default(now()) @updatedAt @map("updated_at")

  // Relations
  biomechanics          ShootingBiomechanics?
  images                ShooterImage[]
  stats                 ShootingStats[]
  strengths             ShootingStrength[]
  weaknesses            ShootingWeakness[]
  habitualMechanics     HabitualMechanics[]

  // ==========================================
  // INDEXES FOR FAST RETRIEVAL
  // ==========================================
  
  // Search by name (most common query)
  @@index([name], name: "idx_shooter_name")
  
  // Filter by skill level (Professional/College/Amateur)
  @@index([skillLevel], name: "idx_skill_level")
  
  // Filter by shooting style (One-motion/Two-motion)
  @@index([shootingStyle], name: "idx_shooting_style")
  
  // Filter by position (Guard/Forward/Center)
  @@index([position], name: "idx_position")
  
  // Filter by era (Modern/Classic/Historical)
  @@index([era], name: "idx_era")
  
  // Sort by shooting percentages (find best shooters)
  @@index([career3ptPercentage], name: "idx_3pt_percentage")
  @@index([careerFgPercentage], name: "idx_fg_percentage")
  @@index([careerFtPercentage], name: "idx_ft_percentage")
  
  // Composite index for common filter combinations
  @@index([skillLevel, position], name: "idx_skill_position")
  @@index([skillLevel, shootingStyle], name: "idx_skill_style")
  @@index([era, skillLevel], name: "idx_era_skill")
  
  // Physical attributes (for matching similar body types)
  @@index([heightInches], name: "idx_height")
  @@index([bodyType], name: "idx_body_type")
  
  @@map("shooters")
}

// ============================================
// TABLE 2: shooting_biomechanics (Detailed form analysis)
// ============================================
model ShootingBiomechanics {
  id                      Int       @id @default(autoincrement()) @map("biomech_id")
  shooterId               Int       @unique @map("shooter_id")
  elbowAngle              Decimal?  @map("elbow_angle") @db.Decimal(5, 2)        // Degrees at release
  shoulderAngle           Decimal?  @map("shoulder_angle") @db.Decimal(5, 2)     // Shoulder rotation
  hipAngle                Decimal?  @map("hip_angle") @db.Decimal(5, 2)          // Hip alignment
  kneeAngle               Decimal?  @map("knee_angle") @db.Decimal(5, 2)         // Knee bend
  ankleAngle              Decimal?  @map("ankle_angle") @db.Decimal(5, 2)        // Ankle position
  releaseHeight           Decimal?  @map("release_height") @db.Decimal(5, 2)     // Height of release in inches
  releaseAngle            Decimal?  @map("release_angle") @db.Decimal(5, 2)      // Ball trajectory angle
  entryAngle              Decimal?  @map("entry_angle") @db.Decimal(5, 2)        // Ball entry angle to hoop
  followThroughExtension  Decimal?  @map("follow_through_extension") @db.Decimal(5, 2)
  balanceScore            Decimal?  @map("balance_score") @db.Decimal(3, 2)      // 0-1 scale
  arcConsistency          Decimal?  @map("arc_consistency") @db.Decimal(3, 2)    // 0-1 scale
  createdAt               DateTime  @default(now()) @map("created_at")

  // Relations
  shooter                 Shooter   @relation(fields: [shooterId], references: [id], onDelete: Cascade)

  // ==========================================
  // INDEXES FOR BIOMECHANICS QUERIES
  // ==========================================
  
  @@index([shooterId], name: "idx_biomech_shooter_id")
  
  // Find shooters with similar elbow angle
  @@index([elbowAngle], name: "idx_elbow_angle")
  
  // Find shooters with similar release angle
  @@index([releaseAngle], name: "idx_release_angle")
  
  // Find shooters with similar knee bend
  @@index([kneeAngle], name: "idx_knee_angle")
  
  // Composite: Find similar shooting form
  @@index([elbowAngle, kneeAngle], name: "idx_elbow_knee")
  @@index([releaseAngle, releaseHeight], name: "idx_release_metrics")
  
  @@map("shooting_biomechanics")
}

// ============================================
// TABLE 3: shooter_images (Image library)
// ============================================
model ShooterImage {
  id                Int       @id @default(autoincrement()) @map("image_id")
  shooterId         Int       @map("shooter_id")
  imageCategory     String?   @map("image_category") @db.VarChar(50)  // form_front/form_side/release_point/follow_through
  imageUrl          String?   @map("image_url") @db.VarChar(500)
  s3Path            String?   @map("s3_path") @db.VarChar(500)        // AWS S3 storage path
  imageResolution   String?   @map("image_resolution") @db.VarChar(20) // 1920x1080 format
  capturePhase      String?   @map("capture_phase") @db.VarChar(50)   // setup/dip/release/follow_through
  shootingAngle     String?   @map("shooting_angle") @db.VarChar(50)  // front/side/45_degree
  isPrimary         Boolean   @default(false) @map("is_primary")
  createdAt         DateTime  @default(now()) @map("created_at")

  // Relations
  shooter           Shooter   @relation(fields: [shooterId], references: [id], onDelete: Cascade)

  // ==========================================
  // INDEXES FOR FAST IMAGE RETRIEVAL
  // ==========================================
  
  // Find all images for a shooter
  @@index([shooterId], name: "idx_images_shooter_id")
  
  // Filter by image category (form_front, form_side, release_point)
  @@index([imageCategory], name: "idx_image_category")
  
  // Filter by capture phase (setup, dip, release, follow-through)
  @@index([capturePhase], name: "idx_capture_phase")
  
  // Filter by shooting angle (front, side, 45-degree)
  @@index([shootingAngle], name: "idx_shooting_angle")
  
  // Find primary images quickly
  @@index([isPrimary], name: "idx_is_primary")
  
  // Composite: Get specific phase/angle for a shooter
  @@index([shooterId, capturePhase], name: "idx_shooter_phase")
  @@index([shooterId, shootingAngle], name: "idx_shooter_angle")
  @@index([shooterId, imageCategory], name: "idx_shooter_category")
  
  // Composite: Get primary image for a shooter
  @@index([shooterId, isPrimary], name: "idx_shooter_primary")
  
  @@map("shooter_images")
}

// ============================================
// TABLE 4: shooting_stats (Season statistics)
// ============================================
model ShootingStats {
  id                Int       @id @default(autoincrement()) @map("stat_id")
  shooterId         Int       @map("shooter_id")
  season            String?   @db.VarChar(20)         // 2023-24 format
  gamesPlayed       Int?      @map("games_played")
  fgAttempts        Int?      @map("fg_attempts")     // Field goal attempts
  fgMade            Int?      @map("fg_made")         // Field goals made
  threePtAttempts   Int?      @map("three_pt_attempts")
  threePtMade       Int?      @map("three_pt_made")
  ftAttempts        Int?      @map("ft_attempts")     // Free throw attempts
  ftMade            Int?      @map("ft_made")         // Free throws made
  pointsPerGame     Decimal?  @map("points_per_game") @db.Decimal(5, 2)
  createdAt         DateTime  @default(now()) @map("created_at")

  // Relations
  shooter           Shooter   @relation(fields: [shooterId], references: [id], onDelete: Cascade)

  // ==========================================
  // INDEXES FOR STATS QUERIES
  // ==========================================
  
  @@index([shooterId], name: "idx_stats_shooter_id")
  @@index([season], name: "idx_season")
  
  // Composite: Get stats for shooter in a season
  @@index([shooterId, season], name: "idx_shooter_season")
  
  @@map("shooting_stats")
}

// ============================================
// TABLE 5: shooting_strengths (What they do well)
// ============================================
model ShootingStrength {
  id                  Int       @id @default(autoincrement()) @map("strength_id")
  shooterId           Int       @map("shooter_id")
  strengthCategory    String?   @map("strength_category") @db.VarChar(100) // Release consistency/Arc/Balance/etc
  description         String?   @db.Text              // Detailed explanation
  confidenceScore     Decimal?  @map("confidence_score") @db.Decimal(3, 2) // 0-1 scale
  createdAt           DateTime  @default(now()) @map("created_at")

  // Relations
  shooter             Shooter   @relation(fields: [shooterId], references: [id], onDelete: Cascade)

  @@index([shooterId], name: "idx_strengths_shooter_id")
  @@map("shooting_strengths")
}

// ============================================
// TABLE 6: shooting_weaknesses (Areas for improvement)
// ============================================
model ShootingWeakness {
  id                  Int       @id @default(autoincrement()) @map("weakness_id")
  shooterId           Int       @map("shooter_id")
  weaknessCategory    String?   @map("weakness_category") @db.VarChar(100) // Footwork/Release/Balance/etc
  description         String?   @db.Text              // Detailed explanation
  severityScore       Decimal?  @map("severity_score") @db.Decimal(3, 2) // 0-1 scale (1 = severe)
  createdAt           DateTime  @default(now()) @map("created_at")

  // Relations
  shooter             Shooter   @relation(fields: [shooterId], references: [id], onDelete: Cascade)

  @@index([shooterId], name: "idx_weaknesses_shooter_id")
  @@map("shooting_weaknesses")
}

// ============================================
// TABLE 7: habitual_mechanics (Shooting habits)
// ============================================
model HabitualMechanics {
  id                    Int       @id @default(autoincrement()) @map("habit_id")
  shooterId             Int       @map("shooter_id")
  habitName             String?   @map("habit_name") @db.VarChar(100)  // Specific habit description
  habitType             String?   @map("habit_type") @db.VarChar(50)   // Good/Bad/Neutral
  frequency             String?   @db.VarChar(50)     // Always/Often/Sometimes/Rarely
  impactOnPerformance   String?   @map("impact_on_performance") @db.Text
  createdAt             DateTime  @default(now()) @map("created_at")

  // Relations
  shooter               Shooter   @relation(fields: [shooterId], references: [id], onDelete: Cascade)

  @@index([shooterId], name: "idx_habits_shooter_id")
  @@map("habitual_mechanics")
}
